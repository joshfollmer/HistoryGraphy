{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'myapp/graph.css' %}">
{% endblock %}

{% block content %}
<div class="banner">
    <div class="banner-content">
        <label for="popup" class="add-node">New Node</label>
    </div>
</div>

<input type="checkbox" id="popup" style="display: none;">
<div class="node-overlay"></div>
<div class="node-model">
    <h1>Create Source</h1>
    <div class="node-input">
        
        <form method="POST" action="/create-node/">
            {% csrf_token %}
            <div class = "node-attribute">
                <p>Title:</p>
                <input type="text" id="node-name" name="node_name" placeholder="Enter source title">
            </div>
            <div class="node-attribute">
                <p>Source type:</p>
                <input type="radio" id="primary" name="source_type" value="primary" style="display:none;">
                <label for="primary" class="node-type-primary">Primary</label>
    
                <input type="radio" id="secondary" name="source_type" value="secondary" style="display:none;">
                <label for="secondary" class="node-type-secondary">Secondary</label>
    
                <script>
                    // Select all labels
                    const labels = document.querySelectorAll('.node-attribute label');
                    
                    // Add click event listener to each label
                    labels.forEach(label => {
                        label.addEventListener('click', function() {
                            // Remove 'selected' class from all labels
                            labels.forEach(l => l.classList.remove('selected'));
                    
                            // Add 'selected' class to the clicked label
                            label.classList.add('selected');
    
                            // Find corresponding radio button and check it
                            const input = document.querySelector(`#${label.getAttribute('for')}`);
                            input.checked = true;
                        });
                    });
                </script>
            </div>
            <div class = "node-attribute">
                <p>Date created:</p>
                <input type="date" id="date-created" name="date_created">
                <script>
                    // Set the max date to today
                    document.addEventListener("DOMContentLoaded", function () {
                        let today = new Date().toISOString().split("T")[0]; 
                        document.getElementById("date-created").setAttribute("max", today);
                    });
                </script>
            </div>
            
            <div class="node-attribute">
                <p>Date discovered:</p>
                <input type="date" id="date-discovered" name="date_discovered" max="{{ today }}">
            </div>
            <div class="node-attribute">
                <p>Language of source:</p>
                <input type="text" id="language" name="language">
            </div>
            <div class="node-attribute">
                <p>Link to source:</p>
                <input type="text" id="link" name="link">
            </div>
            <div class="node-attribute">
                <p>Language of source:</p>
                <input type="text" id="language" name="language">
            </div>
            <div class="node-attribute">
                <p>Description:</p>
                <input type="text" id="description" name="description">
            </div>
            <div class="node-attribute">
                <p>Tags:</p>
                <div class="tags-container">
                    
                    <input type="text" id="tag-input" placeholder="Enter a tag" onkeydown="checkEnter(event)">
                    <button type="button" onclick="addTag()">+</button>
                    
                </div>
                 
            </div>
            <ul id="tags-list"></ul>
            <script>
                let tags = []; // Store the tags in this array
            
                // Function to add a tag when '+' is clicked
                function addTag() {
                    const tagInput = document.getElementById('tag-input');
                    const tagValue = tagInput.value.trim();
            
                    if (tagValue && !tags.includes(tagValue)) {  // Don't add duplicate tags
                        tags.push(tagValue);
                        updateTagsList();
                        tagInput.value = '';  // Clear input field
                    }
                }
            
                // Function to display the tags as a list
                function updateTagsList() {
                    const tagsList = document.getElementById('tags-list');
                    tagsList.innerHTML = '';  // Clear the list
            
                    tags.forEach(tag => {
                        const li = document.createElement('li');
                        li.textContent = tag;
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'x';
                        removeBtn.onclick = () => removeTag(tag);
                        li.appendChild(removeBtn);
                        tagsList.appendChild(li);
                    });
                }
            
                // Function to remove a tag
                function removeTag(tag) {
                    tags = tags.filter(t => t !== tag); // Remove the tag from the array
                    updateTagsList(); // Update the displayed list
                }
            
                // Allow the user to press Enter to add a tag
                function checkEnter(event) {
                    if (event.key === 'Enter') {
                        addTag();
                    }
                }
            </script>

            
            



            <div class ="buttons">
                <input type="submit" class="node-model-close" value="Create">
                <input type="button" id="cancel-button" class="node-model-close" value="Cancel">
            </div>

            <script src="{% static 'js/popup_close.js' %}"></script>

        </form>
    </div>
</div>

    <div id="cy"></div> <!-- Cytoscape container -->

    <!-- Pass Django nodes and edges data to JavaScript safely -->
    <script>
        let nodes = JSON.parse('{{ nodes|escapejs }}');
        let edges = JSON.parse('{{ edges|escapejs }}');
    </script>

{% endblock %}

{% block extra_js %}
    <!-- Cytoscape.js -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.22.0/dist/cytoscape.min.js"></script>
    <script src="{% static 'js/graph.js' %}"></script>
{% endblock %}
