{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'myapp/graph.css' %}">
{% endblock %}

{% block content %}
<div class="banner">
    <div class="banner-content">
        <label for="popup" class="add-node">New Node</label>
    </div>
</div>

<input type="checkbox" id="popup" style="display: none;">
<div class="node-overlay"></div>
<div class="node-model">
    <h1>Create Source</h1>
    <div class="node-input">
        <form method="POST" id="create-node-form" action="/create-node/">
            {% csrf_token %}
            <div class="node-attribute">
                <p>Title:</p>
                <input type="text" id="node-name" name="node_name" placeholder="Enter source title">
                <p id="node-name-error" style="color: red; display: none;">Title is required</p>
            </div>
            <div class="node-attribute">
                <p>Source type:</p>
                <input type="radio" id="primary" name="source_type" value="primary" style="display:none;">
                <label for="primary" class="node-type-primary">Primary</label>
                <input type="radio" id="secondary" name="source_type" value="secondary" style="display:none;">
                <label for="secondary" class="node-type-secondary">Secondary</label>
            </div>
            <div class="node-attribute">
                <p>Author/creator:</p>
                <input type="text" id="author" name="author">
            </div>
            <div class="node-attribute">
                <p>Date created:</p>
                <input type="date" id="date-created" name="date_created">
            </div>
            <div class="node-attribute">
                <p>Date discovered:</p>
                <input type="date" id="date-discovered" name="date_discovered">
            </div>
            <div class="node-attribute">
                <p>Language of source:</p>
                <input type="text" id="language" name="language">
            </div>
            <div class="node-attribute">
                <p>Link to source:</p>
                <input type="text" id="link" name="link">
            </div>
            <div class="node-attribute">
                <p>Description:</p>
                <input type="text" id="description" name="description">
            </div>
            <div class="node-attribute">
                <p>Tags:</p>
                <input type="text" id="tag-input" placeholder="Enter a tag" onkeydown="checkEnter(event)">
                <button type="button" onclick="addTag()">+</button>
                <ul id="tags-list"></ul>
            </div>
            <div class="buttons">
                <input type="submit" class="node-model-close" value="Create">
                <input type="button" class="node-model-close" value="Cancel">
            </div>
        </form>
    </div>
</div>

<div id="cy"></div> <!-- Cytoscape container -->

{% block extra_js %}
<script>
    let tags = [];
    
    function addTag() {
        const tagInput = document.getElementById('tag-input');
        const tagValue = tagInput.value.trim();
        if (tagValue && !tags.includes(tagValue)) {
            tags.push(tagValue);
            updateTagsList();
            tagInput.value = '';
        }
    }

    function updateTagsList() {
        const tagsList = document.getElementById('tags-list');
        tagsList.innerHTML = '';
        tags.forEach(tag => {
            const li = document.createElement('li');
            li.textContent = tag;
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'x';
            removeBtn.onclick = () => removeTag(tag);
            li.appendChild(removeBtn);
            tagsList.appendChild(li);
        });
    }

    function removeTag(tag) {
        tags = tags.filter(t => t !== tag);
        updateTagsList();
    }

    function checkEnter(event) {
        if (event.key === 'Enter') {
            addTag();
        }
    }

    document.getElementById('create-node-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const title = document.getElementById('node-name').value;
        const sourceType = document.querySelector('input[name="source_type"]:checked') ? document.querySelector('input[name="source_type"]:checked').value : null;
        const author = document.getElementById('author').value;
        const dateCreated = document.getElementById('date-created').value;
        const dateDiscovered = document.getElementById('date-discovered').value;
        const language = document.getElementById('language').value;
        const url = document.getElementById('link').value;
        const description = document.getElementById('description').value;

        // Validate form
        if (!title || !dateCreated || !author || !language) {
            alert('Please fill out all required fields');
            return;
        }

        if(!dateDiscovered){
            dateDiscovered = dateCreated;
        }

        // Create node object
        const newNode = {
            title,
            author,
            is_primary: sourceType === 'primary',
            date_created: dateCreated,
            date_discovered: dateDiscovered,
            description,
            url,
            language,
            tags,
        };

        // Send data to Django server
        fetch('/create-node/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(newNode)
        })
        .then(response => response.json())
        .then(data => {
            // Render the node on the graph
            const cy = cytoscape({
                container: document.getElementById('cy'),
                elements: [
                    {
                        data: {  label: data.title }
                    }
                ],
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#007bff',
                            'label': 'data(label)',
                            'width': '30px',
                            'height': '30px'
                        }
                    }
                ],
                layout: { name: 'grid', rows: 2 }
            });
        })
        .catch(error => console.error('Error:', error));
    });
</script>
{% endblock %}
{% endblock %}
